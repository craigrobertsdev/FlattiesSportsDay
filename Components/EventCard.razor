@using SportsDayScoring.Components.Pages
@using SportsDayScoring.Models

@inject NavigationManager NavManager

<div
    class="grid grid-cols-[150px_repeat(4,_0.7fr)_1fr] grid-rows-2 overflow-x-auto border border-black w-\[500px\] mb-3">
    <div class="pl-2 row-start-1 row-span-2 col-start-1 flex justify-center items-center font-bold bg-slate-200">
        @Event.Name
    </div>
    @for (int i = 0; i < 4; i++)
    {
        var idx = i;
        var houseName = AppConstants.HouseNames[i];
        <div class="row-start-1 row-span-2 col-start-@(idx + 2)">
            <div class="row-span-2">
                @* // For where the event has not been completed yet *@
                @if (!Event.IsSaved)
                {
                    <select class="border-b w-full text-center @AppConstants.HouseBackgroundColours[idx] p-1"
                            @onchange=@((e) => HandleAthleticScoreChange(e, houseName))>
                        <option disabled hidden selected>Athletic</option>
                        @foreach (var score in AppConstants.AthleticScores)
                        {
                            <option value="@score">@score</option>
                        }
                    </select>
                    <select class="w-full text-center @AppConstants.HouseBackgroundColours[idx] p-1"
                            @onchange=@((e) => HandleSpiritScoreChange(e, houseName))>
                        <option disabled hidden selected>Spirit</option>
                        @foreach (var score in AppConstants.SpiritScores)
                        {
                            <option value="@score">@score</option>
                        }
                    </select>
                }
                else
                {
                    <div class="border-b w-full text-center @AppConstants.HouseBackgroundColours[idx] p-1">
                        @Event.ScoreCards.Get(houseName).AthleticPoints
                    </div>
                    <div class="w-full text-center @AppConstants.HouseBackgroundColours[idx] p-1">
                        @Event.ScoreCards.Get(houseName).SpiritPoints
                    </div>
                }
            </div>
        </div>
    }
    @if (Event.IsSaved)
    {
        <div class="flex row-start-1 row-span-2 col-start-6 justify-center items-center font-bold bg-slate-400"></div>
    }
    else
    {
        <button
            class="row-start-1 row-span-2 col-start-6 @(_isError ? "bg-red-600" : "bg-slate-100") font-bold"
            @onclick="SaveScores">
            Save Scores
        </button>
    }
</div>

@code {
    [Parameter] public ClassEvents Parent { get; set; } = null!;
    [Parameter] public Event Event { get; set; } = null!;
    [Parameter] public bool Disabled { get; set; }
    private bool _isError;

    private async Task SaveScores()
    {
        _isError = false;
        if (Event.ScoreCards.Any(v => v.AthleticPoints == 0))
        {
            _isError = true;
            return;
        }

        Event.IsSaved = true;

        try
        {
            await Parent.DataService.UpdateEvent(Event);
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }

        RefreshPage();
    }

    private void HandleAthleticScoreChange(ChangeEventArgs e, HouseName houseName)
    {
        Event.ScoreCards.Get(houseName).AthleticPoints = Int32.Parse((string)e.Value!);
        StateHasChanged();
    }

    private void HandleSpiritScoreChange(ChangeEventArgs e, HouseName houseName)
    {
        Event.ScoreCards.Get(houseName).SpiritPoints = Int32.Parse((string)e.Value!);
        StateHasChanged();
    }

    private void RefreshPage()
    {
        NavManager.NavigateTo($"/class-events/{Parent.RoomNumber}", true);
    }

}